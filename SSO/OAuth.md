# OAuth2



# 概述



* OAuth2可以提供一个统一的认证服务,主要模块如下:
  * Resource Owner(RO):资源拥有者.拥有该资源的服务或用户,如我们自己或者资源网站
  * Authorization Server(AS):认证服务器.即用来认证与颁发令牌(如token)的服务
  * Resource Server(RS):资源服务器.拥有资源的服务,如我们要访问的网站
  * Client:客户端.即访问的客户端,如我们自己用的访问网站



# 授权模式



* 授权码模式:authorization_code.适用于Web和移动应用程序.用户首先被重定向到授权服务器,授权服务器会要求用户授权应用程序访问其数据.如果用户同意授权,授权服务器会向应用程序颁发授权码.应用程序使用授权码向授权服务器请求访问令牌
* 客户端模式:client_credentials.适用于应用程序(服务器)之间的数据交换.应用程序使用自己的客户端 ID 和客户端密钥向授权服务器请求访问令牌.授权服务器验证客户端 ID 和客户端密钥后,向应用程序颁发访问令牌
* 密码模式:password,不安全.适用于应用程序需要直接从用户那里获取用户名和密码的情况.应用程序向授权服务器发送用户名和密码,授权服务器验证用户名和密码后,向应用程序颁发访问令牌
* 隐式授权模式:implicit,不安全.适用于不需要服务器端存储令牌的应用程序.用户被重定向到授权服务器,授权服务器要求用户授权应用程序访问其数据.如果用户同意授权,授权服务器会向应用程序颁发访问令牌,无需先获取授权码
* 设备授权模式:device,oauth2.1新模式
* 刷新模式:refresh_token.用刷新码获取



## 授权码



![](img/001.png)



* 先申请授权码code,得到code后再用来申请access_token

* 以QQ的AS(认证服务器)为例:

  * Client向用户展示,可以支持QQ、微信等第三方登录.用户选择QQ,则跳转至QQ登录界面,通常为WEB界面.此时,若用户未登录,则要求用户登录,若已登录,则询问是否授权,以及展示授权后会获得哪些权限
  * 用户点击授权,触发申请
  * 授权通过,QQ的AS将用户导向Client事先指定的重定向URI(redirection URI),同时附上一个code
  * Client收到code,附上早先的重定向URI,向AS申请access_token.这一步是在Client的后台的服务器上完成的,对用户不可见
  * AS核对了授权码和重定向URI,确认无误后,向Client发送访问令牌(access_token)和更新令牌(refresh_token)

* code只能使用一次,且有时间限制

* 申请code时,需要在URI的query中附加以下信息

  * response_type:REQUIRED.  Value MUST be set to "code"
  * client_id:REQUIRED.  The client identifier
  * redirect_uri:OPTIONAL
  * scope:OPTIONAL.  The scope of the access request
  * state:RECOMMENDED.  An opaque value used by the client to maintain state between the request and callback.  The redirecting the user-agent back to the client.  The parameter SHOULD be used for preventing cross-site request forgery

* code返回时,URI的query中的附加信息如下

  * code:REQUIRED.The authorization code generated by the authorization server.  The authorization code MUST of expire shortly after it is issued to mitigate the risk of leaks.  A maximum authorization code lifetime of 10 minutes is RECOMMENDED.  The client MUST NOT use the authorization code more than once.  If an authorization code is used more than once, the authorization server MUST deny the request and SHOULD revoke (when possible) 
    all tokens previously issued based on that authorization code.  The authorization code is bound to the client identifier and redirection URI
  * state:REQUIRED if the "state" parameter was present in the client authorization request.  The exact value received from the client

* 使用code申请access_token时,需要在HTTP request entity-body中提交以下信息

  * grant_type:REQUIRED.  Value MUST be set to "authorization_code"
  * code:REQUIRED.  The authorization code received from the authorization server
  * redirect_uri:REQUIRED, if the "redirect_uri" parameter was included in the authorization request, and their values MUST be identical
  * client_id:REQUIRED, if the client is not authenticating with the authorization server

* 申请成功后,授权服务器将返回access token和token有效时间,以及可选的refresh token

* eg

  ```
  GET /authorize?response_type=code&client_id=s6BhdRkqt3&state=xyz&redirect_uri=https%3A%2F%2Fclient%2Eexample%2Ecom%2Fcb HTTP/1.1
  Host: server.example.com
  
  Authorization Code Response：
  
  HTTP/1.1 302 Found
  Location: https://client.example.com/cb?code=SplxlOBeZQQYbYS6WxSbIA&state=xyz
  1
  2
  Request Access Token：
  
       POST /token HTTP/1.1
       Host: server.example.com
       Authorization: Basic czZCaGRSa3F0MzpnWDFmQmF0M2JW
       Content-Type: application/x-www-form-urlencoded
  
       grant_type=authorization_code&code=SplxlOBeZQQYbYS6WxSbIA
       &redirect_uri=https%3A%2F%2Fclient%2Eexample%2Ecom%2Fcb
  
  Access Token Response：
  
       HTTP/1.1 200 OK
       Content-Type: application/json;charset=UTF-8
       Cache-Control: no-store
       Pragma: no-cache
  
       {
         "access_token":"2YotnFZFEjr1zCsicMWpAA",
         "token_type":"example",
         "expires_in":3600,
         "refresh_token":"tGzv3JOkF0XG5Qx2TlKWIA",
         "example_parameter":"example_value"
       }
  ```

  



## 客户端



* 该模式下,并不存在对个体用户授权的行为,被授权的主体为client.因此,该模式可用于对某类用户进行集体授权

* 请求

  * POST
  * grant_type:REQUIRED.Value MUST be set to "client_credentials"
  * scope:OPTIONAL.  The scope of the access request

* 响应

  * access_token:此次请求的token
  * token_type:token类型
  * expires_in:token有效时长,单位为秒

* eg

  ```
  Request：
  
       POST /token HTTP/1.1
       Host: server.example.com
       Authorization: Basic czZCaGRSa3F0MzpnWDFmQmF0M2JW
       Content-Type: application/x-www-form-urlencoded
  
       grant_type=client_credentials
       
  Response：
  
       HTTP/1.1 200 OK
       Content-Type: application/json;charset=UTF-8
       Cache-Control: no-store
       Pragma: no-cache
  
       {
         "access_token":"2YotnFZFEjr1zCsicMWpAA",
         "token_type":"example",
         "expires_in":3600
       }
  ```



## 密码



![](img/003.png)



* 需要用户将自身的用户名和密码交由client,client将使用它们来申请access_token,用户信息会暴露.除非client十分可靠(例如硬件,系统APP),否则,不建议使用该模式

* 请求

  * POST
  * grant_type:REQUIRED.  Value MUST be set to "password"
  * username:REQUIRED.  The resource owner username
  * password:REQUIRED.  The resource owner password
  * scope:OPTIONAL.  The scope of the access request

* 响应

  * access_token:此次请求的token
  * token_type:token类型
  * expires_in:token有效时长,单位为秒
  * refresh_token:此次请求token过期时,下一次请求token时携带的token

* eg:

  ```
  Request：
  
       POST /token HTTP/1.1
       Host: server.example.com
       Authorization: Basic czZCaGRSa3F0MzpnWDFmQmF0M2JW
       Content-Type: application/x-www-form-urlencoded
  
       grant_type=password&username=user11&password=123456
  
  Response：
  
       HTTP/1.1 200 OK
       Content-Type: application/json;charset=UTF-8
       Cache-Control: no-store
       Pragma: no-cache
  
       {
         "access_token":"2YotnFZFEjr1zCsicMWpAA",
         "token_type":"example",
         "expires_in":3600,
         "refresh_token":"tGzv3JOkF0XG5Qx2TlKWIA"
       }
  ```

  



## 隐式



![](img/004.png)



* 在授权码模式中,code和access_token都由授权服务器生成和验证,而最终只用到access_token,这让code显得无足轻重.因此,授权码简化模式,去掉了code的申请流程,从而通过User-Agent(Browser)直接申请access_token

* 以QQ的AS为例

  * Client向用户展示,可以支持QQ、微信等第三方登录.用户选择QQ,则跳转至QQ界面,通常为WEB界面.此时,若用户未登录,则要求用户登录,若已登录,则询问是否授权,以及展示授权后会获得哪些权限
  * 用户点击授权,触发申请
  * 授权通过,QQ AS将用户导向Client事先指定的重定向URI(redirection URI),同时附上access_token
  * QQ(User-Agent)收到重定向响应后,向Client提出请求,表示想提取URI中的access_token
  * Client返回带有解析脚本的页面,用于解析重定向URI fragment中的access_token
  * User-Agent使用解析脚本,获取access_token
  * User-Agent将access_token转交给Client

* 申请access_token时,需要在URI的query中附加以下信息

  * response_type:REQUIRED.  Value MUST be set to "token"
  * client_id:REQUIRED.  The client identifier
  * redirect_uri:OPTIONAL
  * scope:OPTIONAL. The scope of the access request
  * state:RECOMMENDED.  An opaque value used by the client to maintain state between the request and callback.  The authorization server includes this value when redirecting the user-agent back to the client.  The parameter SHOULD be used for preventing cross-site request forgery

* access_token返回时,URI的query中的附加信息如下

  * access_token:REQUIRED.  The access token issued by the authorization server
  * token_type:REQUIRED.  The type of the token issued.  Value is case insensitive
  * expires_in:RECOMMENDED.  The lifetime in seconds of the access token.  For example, the value "3600" denotes that the access token will expire in one hour from the time the response was generated. If omitted, the authorization server SHOULD provide the expiration time via other means or document the default value
  * scope:OPTIONAL, if identical to the scope requested by the client; otherwise, REQUIRED.  The scope of the access token
  * state:REQUIRED if the "state" parameter was present in the client authorization request.  The exact value received from the client

* eg

  ```
  Request:
  
  GET /authorize?response_type=token&client_id=s6BhdRkqt3&state=xyz&redirect_uri=https%3A%2F%2Fclient%2Eexample%2Ecom%2Fcb HTTP/1.1
  Host: server.example.com
  
  Response:
  
  HTTP/1.1 302 Found
  Location: http://example.com/cb#access_token=2YotnFZFEjr1zCsicMWpAA&state=xyz&token_type=example&expires_in=3600
  ```







